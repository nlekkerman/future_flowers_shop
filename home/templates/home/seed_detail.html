{% extends "base.html" %} {% load static %} {% block content %}
<div class="container mt-5">
  
  <h1 class="text-center mb-4 dark-rgba-background">{{ seed.name }}</h1>
  <div class="mt-3 mb-3">
    <a href="{% url 'home:home' %}" class="btn send-button">
      ⏪ Continue Shopping
    </a>
  </div>
  <!-- Seed Details -->
  <div class="col p-0 d-flex justify-content-center align-items-center flex-column">
    <div class="col-md-6 p-0">
      {% if seed.image %}
      <img
        src="{{ seed.image.url }}"
        class="img-fluid rounded shadow card-img-top"
        alt="{{ seed.name }} - Buy Online"
        loading="lazy"
      />
      {% else %}
      <img
        src="{% static 'images/default-seed.jpg' %}"
        class="img-fluid rounded shadow"
        alt="Default Seed Image"
      />
      {% endif %}
    </div>

    <div class="col-md-6 dark-rgba-background pb-3 d-flex flex-column justify-content-center">
      <h4>Scientific Name: {{ seed.scientific_name }}</h4>
      <p><strong>Rating:</strong>
        {% if seed.avg_rating %}
            <span class="badge bg-success fs-6 px-3 py-2 rounded-pill">
                {{ seed.avg_rating|floatformat:1 }}/5
            </span>
        {% else %}
            <span class="badge bg-secondary fs-6 px-3 py-2 rounded-pill">
                No ratings yet
            </span>
        {% endif %}
    </p>
      <p><strong>Category:</strong> {{ seed.get_category_display }}</p>
      <p>
        <strong>Sun Preference:</strong> {{ seed.get_sun_preference_display }}
      </p>
      <h3 class="mt-3">
        Price: {% if seed.has_discount %}
        <span class="text-danger">${{ seed.calculate_discounted_price }}</span>
        <del class="text-muted">${{ seed.price }}</del>
        {% else %} ${{ seed.price }} {% endif %}
      </h3>
      {% if seed.is_in_stock %}
      <span class="badge bg-success">In Stock: {{ seed.in_stock_number }}</span>
      <form
        method="POST"
        action="{% url 'cart:add_to_cart' seed.id %}"
        class="mt-3"
      >
        {% csrf_token %}
        <div class="form-group ">
          <label for="quantity">Quantity:</label>
          <input
            type="number"
            name="quantity"
            id="quantity"
            class="form-control w-50"
            value="1"
            min="1"
            max="{{ seed.in_stock_number }}"
            step="1"
          />
        </div>
        <div class="d-flex justify-content-center">
        <button type="submit" class="btn send-button mt-2">
          🛒 Add to Cart
        </button>
      </div>
      </form>
      {% else %}
      <span class="badge bg-danger">Out of Stock</span>
      {% endif %}
     
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="my-5 reviews-container p-2">
    <h2>📝 Reviews & Comments</h2>

    {% if reviews %}
    <ul class="list-group list-unstyled pb-2">
      {% for review in reviews %}
      <li class="list-group-item dark-rgba-background">
        <div class="d-flex justify-content-between ">
          <strong>{{ review.user.username }}</strong>
          <small class="text-muted">
            {{ review.created_at|date:"F j, Y, g:i a" }}
          </small>
        </div>
        <p>{{ review.comment }}</p>

        <!-- Display the number of approved comments for this review -->
        <small class="text-muted">
          {{ review.approved_comments_count_display }}
        </small>

        {% if request.user == review.user %}
        <div class="mt-2">
          <a
            href="{% url 'reviews:edit_review' review.id %}"
            class="btn btn-sm btn-warning"
            >✏ Edit</a
          >
          <a
            href="{% url 'reviews:delete_review' review.id %}"
            class="btn btn-sm btn-danger"
            onclick="return confirm('Are you sure?');"
            >🗑 Delete</a
          >
        </div>
        {% endif %}

        <!-- Display Comments under each Review -->
        <ul class="list-group mt-2 list-unstyled">
          {% if review.comments.count == 0 %}
          <li class="text-white bg-info text-center">No comments yet.</li>
          {% else %} {% for comment in approved_comments %}
          <li class="comment-body light-rgba-background rounded p-1">
            <strong>{{ comment.user.username }}</strong><br> {{ comment.text }}
            <small class="text-muted d-block">
              {{ comment.created_at|date:"F j, Y, g:i a" }}
            </small>

            {% if request.user == comment.user %}
            <div class="mt-1">
              <a
                href="{% url 'reviews:edit_comment' comment.id %}"
                class="btn btn-sm btn-warning"
                >✏ Edit</a
              >
              <a
                href="{% url 'reviews:delete_comment' comment.id %}"
                class="btn btn-sm btn-danger"
                onclick="return confirm('Are you sure?');"
                >🗑 Delete</a
              >
            </div>
            {% endif %}
          </li>
          {% endfor %} {% endif %}
        </ul>

        <!-- Add a comment form under each review -->
        {% if user.is_authenticated %}
        <form method="POST" class="mt-2">
          {% csrf_token %}
          <input type="hidden" name="review_id" value="{{ review.id }}" />
          <textarea
            name="text"
            class="form-control mb-2"
            placeholder="Write a comment..."
          ></textarea>
          <button
            type="submit"
            name="comment_submit"
            class="btn btn-sm send-button"
          >
            💬 Add Comment
          </button>
        </form>
        {% else %}
        <p class="mt-2"><a href="{% url 'custom_accounts:account_login' %}">Log in</a> to comment.</p>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="text-white bg-info text-center mb-3">
      No reviews yet. Be the first to review this seed! 🌱
    </p>
    {% endif %}
  </div>

  <!-- Add a Review Form -->
  {% if user.is_authenticated %}
  <div class="mt-4 reviews-container">
    <h3>💬 Leave a Review</h3>
    <form method="POST">
      {% csrf_token %}
      <div class="form-group">{{ review_form.as_p }}</div>
      <button type="submit" name="review_submit" class="btn send-button mb-3 ml-1">
        ✍️ Submit Review
      </button>
    </form>
  </div>
  {% else %}
  <p class="mt-4"><a href="{% url 'custom_accounts:account_login' %}">Log in</a> to leave a review.</p>
  {% endif %}
</div>
<!-- Modal for Displaying Messages -->
{% if messages %}
<div class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel" aria-hidden="true" data-show-modal="true">
    <div class="modal-dialog dark-rgba-background" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalLabel">Message</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <a href="{% url 'home:home' %}" class="btn send-button">Go to Home</a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- JavaScript to Trigger Modal on Success -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Check if the modal should be shown using a data attribute (data-show-modal)
    var modalElement = document.querySelector('#messageModal');
    if (modalElement && modalElement.getAttribute('data-show-modal') === 'true') {
      $('#messageModal').modal('show');
    }
  });
</script>
{% endblock %}
